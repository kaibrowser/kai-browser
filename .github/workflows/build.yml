name: Build Kai Browser

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Qt6 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            libxkbcommon-x11-0 \
            libegl1 \
            libgl1 \
            libdbus-1-3

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine selenium webdriver-manager keyring requests

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name kaibrowser \
            --icon=kai-browser_logo.ico \
            --add-data "kai-browser_logo.png:." \
            --hidden-import=PyQt6 \
            --hidden-import=selenium \
            --hidden-import=webdriver_manager \
            --hidden-import=keyring \
            --hidden-import=requests \
            launch_browser.py

          cp kai-browser_logo.png dist/kaibrowser.png
          cp DISCLAIMER.md dist/ 2>/dev/null || true
          cp README.md dist/ 2>/dev/null || true
          cp LICENSE.save dist/ 2>/dev/null || true
          cp TERMS_OF_SERVICE.md dist/ 2>/dev/null || true
          cp HOW_TO_INSTALL.txt dist/ 2>/dev/null || true
          cp install.sh dist/ 2>/dev/null || true
          cp uninstall.sh dist/ 2>/dev/null || true

      - name: Package Linux build
        run: |
          cd dist
          tar -czf ../kaibrowser-linux.tar.gz *
          cd ..

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: kaibrowser-linux
          path: kaibrowser-linux.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: kaibrowser-linux.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka PyQt6 PyQt6-WebEngine selenium webdriver-manager keyring requests Pillow qrcode numpy pandas beautifulsoup4 lxml cryptography

      - name: Build with Nuitka
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --windows-console-mode=disable `
            --windows-icon-from-ico=kai-browser_logo.ico `
            --include-data-file=kai-browser_logo.png=kai-browser_logo.png `
            --enable-plugin=pyqt6 `
            --include-module=selenium `
            --include-module=webdriver_manager `
            --include-module=keyring `
            --include-module=requests `
            --include-module=PIL `
            --include-module=qrcode `
            --include-module=numpy `
            --include-module=pandas `
            --include-module=bs4 `
            --include-module=lxml `
            --include-module=cryptography `
            --output-dir=dist `
            --output-filename=kaibrowser.exe `
            launch_browser.py

          Copy-Item kai-browser_logo.png dist\ -ErrorAction SilentlyContinue
          Copy-Item DISCLAIMER.md dist\ -ErrorAction SilentlyContinue
          Copy-Item README.md dist\ -ErrorAction SilentlyContinue
          Copy-Item LICENSE.save dist\ -ErrorAction SilentlyContinue
          Copy-Item TERMS_OF_SERVICE.md dist\ -ErrorAction SilentlyContinue
        shell: pwsh

      - name: Package Windows build
        run: |
          Compress-Archive -Path dist\* -DestinationPath kaibrowser-windows.zip
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: kaibrowser-windows
          path: kaibrowser-windows.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: kaibrowser-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}